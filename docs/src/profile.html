<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile</title>
  <link rel="stylesheet" href="../index.css" />
  <style>
    body {
      margin: 0;
      font-family: "Space Mono", monospace;
      min-height: 100vh;
      background: url(https://images.pexels.com/photos/15971283/pexels-photo-15971283/free-photo-of-traditional-houses-in-city-at-night.png)
        no-repeat center center fixed;
      background-size: cover;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .profile-container {
      margin-top: 80px;
      max-width: 700px;
      width: 90%;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .profile-info p {
      margin: 8px 0;
      font-size: 1rem;
    }

    input, textarea {
      width: 100%;
      margin-top: 5px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    textarea::placeholder, input::placeholder {
      color: rgba(255, 255, 255, 0.8);
    }

    .save-btn {
      margin-top: 15px;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
    }

    .save-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .private-message {
      text-align: center;
      font-size: 1.2rem;
      padding: 20px;
    }
  </style>
</head>

<body>
  <div class="profile-container" id="profileContainer">
    <h1 id="profileTitle">Your Profile</h1>
    <div class="profile-info">
      <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
      <p><strong>Name:</strong> <input id="nameInput" placeholder="Your name" /></p>
      <p><strong>School:</strong> <input id="schoolInput" placeholder="Your school" /></p>
      <p><strong>Description:</strong></p>
      <textarea id="descriptionInput" placeholder="Tell others about your study habits, favorite subjects, etc."></textarea>
      <div style="margin-top:10px;">
        <label><input type="checkbox" id="publicProfileToggle" /> Public Profile</label>
      </div>
      <button class="save-btn" id="saveProfileBtn">Save Changes</button>
    </div>
  </div>

  <script type="module">
    import { renderNavBar } from "../module/nav.js";
    renderNavBar("profile");

    import { auth } from "../module/auth.js";
    import { db } from "../config/firebase.js";
    import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const profileTitle = document.getElementById("profileTitle");
    const nameInput = document.getElementById("nameInput");
    const schoolInput = document.getElementById("schoolInput");
    const descriptionInput = document.getElementById("descriptionInput");
    const publicToggle = document.getElementById("publicProfileToggle");
    const saveBtn = document.getElementById("saveProfileBtn");
    const userEmail = document.getElementById("userEmail");
    const profileContainer = document.getElementById("profileContainer");
    const params = new URLSearchParams(window.location.search);
    const viewedUid = params.get("uid");

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Redirect with return path so user goes back to profile after signing in
        window.location.href = `../signin.html?redirect=${encodeURIComponent("src/profile.html")}`;
        return;
      }

      const isOwnProfile = !viewedUid || viewedUid === user.uid;
      const userRef = doc(db, "users", viewedUid || user.uid);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        if (isOwnProfile) {
          await setDoc(userRef, { public: false, name: "", school: "", description: "" });
        } else {
          profileContainer.innerHTML = "<div class='private-message'>This profile is private.</div>";
          return;
        }
      }

      const data = (await getDoc(userRef)).data();

      if (!isOwnProfile) {
        if (!data.public) {
          profileContainer.innerHTML = "<div class='private-message'>This profile is private.</div>";
          return;
        }
        profileContainer.innerHTML = `
          <h2>${data.name || "Unknown User"}</h2>
          <p><strong>School:</strong> ${data.school || "(not set)"}</p>
          <p><strong>Description:</strong> ${data.description || "(no description provided)"}</p>
        `;
        return;
      }

      userEmail.textContent = user.email;
      nameInput.value = data.name || "";
      schoolInput.value = data.school || "";
      descriptionInput.value = data.description || "";
      publicToggle.checked = !!data.public;

      saveBtn.addEventListener("click", async () => {
        await updateDoc(userRef, {
          name: nameInput.value,
          school: schoolInput.value,
          description: descriptionInput.value,
          public: publicToggle.checked
        });
        alert("Profile updated!");
      });
    });
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
</body>
</html>
